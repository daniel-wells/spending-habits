---
title: "Personal Finance"
output: github_document
---

Since 2011 I have been keeping meticulous records of everything I spend money on. I really mean everything, including for example the 6p I spend on a 75g carrot I bought at 7:47pm on the 2nd of August 2014 at Tesco (store id 2990)! There's a total of 1412 recipts covering a duration of 5 and a half years.

```{r load_librarys, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, fig.width=10, fig.asp=1/1.5, fig.retina=2, message=FALSE, warning=FALSE)
library(data.table, quietly = TRUE)
library(ggplot2)
library(lubridate)
library(dplyr)
library(scales)
library(ggTimeSeries) 
#library(plotly)
```

Looking at the distribution of item prices integer values (£1, £2 etc.) are more common, as well as 25p and 50p increments. I guess consumers prefer round numbers so companies size products accordingly (or just round up and take the difference as profit).

```{r item-prices, fig.width=10}
undergrad <- fread("Finance - Undergrad Expenses.tsv")
dphil <- fread("Finance - DPhil Expenses.tsv")

Finance <- rbind(undergrad[, -c("Day","Notes"), with=FALSE], dphil[, -c("Totals:","V13"), with=FALSE])
Finance <- Finance[Item != ""] # remove empty lines

#nrow(unique(Finance[,c("Date","Time")]))
#round(as.numeric((max(Finance$Date, na.rm=T) - min(Finance$Date, na.rm=T))/365),1)

# Reformat Date and Time
Finance[, Date := dmy(Date)]
Finance[, Year := as.factor(paste("Year",Year))]
Finance[, Time := as.POSIXct(substr(Time, 0, 5), tz = "GMT", format = '%H:%M')]
Finance[, Term := factor(Term, levels=c("Michaelmas","Christmas","Hilary","Trinity","Summer"))]
Finance[, Category := as.factor(Category)]
Finance[, Percentage := Price / sum(Price, na.rm = TRUE)]

# Distribution of Item Prices
ggplot(Finance, aes(Price)) +
  geom_histogram(binwidth=0.02) +
  scale_x_continuous(labels = dollar_format(prefix = "£"), limits=c(0,5)) +
  labs(x="Price", y="Number of Items")
```

Looking at the daily spend over time clearly shows the periods I was at university and the periods I was at home (with food etc. paid for by my parents) by the gaps where daily spending is £0. You can also see the peak in expenditure at the start of each month due to rent payments.

The vast majority of days I spent less than £10 (excluding accommodation), and again you can see spikes at integer and X.5 values. Note that on days when I spent nothing I did not record anything so these do not appear in the graph as a spike at £0.

```{r by-day, fig.width=10}
# Aggregate: Price Per Day
FinanceByDay <- Finance[,.(Spend = sum(Price, na.rm=T), Term=unique(Term)), by = Date]

ggplot_calendar_heatmap(FinanceByDay[!is.na(Date)], 'Date', 'Spend') +
  theme(legend.position = "bottom", legend.key.width=unit(3,"cm")) +
  scale_fill_distiller(palette = 'YlOrRd', direction = 1, trans = "log10", breaks=c(1,5,10,50,100,500), labels = dollar_format(prefix = "£")) +
  facet_wrap(~Year, ncol = 1)

# Distribution of Spend per Day
ggplot(FinanceByDay, aes(Spend)) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(labels = dollar_format(prefix = "£"), minor_breaks = 1:25, limits=c(0,25)) +
  labs(x="Daily Spend (£)", y="# of Days with a given spend")
```

There are also time of day patterns for example during the summer terms when I did internships I didn't buy anything between 9am and 5pm on weekdays because I was working. Aggregating over all years it seems my favourite shopping times are 1pm and 7pm (lunch and dinner!).

```{r by-time, fig.width=10}
ggplot(Finance, aes(Date, Time, colour=Term, shape=weekdays(Date)%in%c("Saturday","Sunday"))) +
  geom_point() +
  scale_x_date(date_breaks = "1 year", date_minor_breaks="1 month", date_labels = "Start of %Y") +
  scale_y_datetime(date_breaks = "2 hours", date_labels = "%H:%M", minor_breaks = NULL, limits=as.POSIXct(c("7",NA),format = "%H")) +
  theme(legend.position = "bottom") + facet_wrap(~Year, scales = "free_x") +
  scale_shape_manual(values=c(16,1)) +
  scale_color_brewer(palette="Set1") +
  labs(shape="Weekend?")

#  geom_vline(xintercept=as.numeric(ymd("2016-10-25"))) +
#  geom_vline(xintercept=as.numeric(ymd("2016-09-08"))) +
#  geom_vline(xintercept=as.numeric(ymd("2016-09-10"))) +
#  facet_zoom(x = Date > ymd("2016-06-01") & Date < ymd("2016-12-01"))

time_histogram <- hist(Finance$Time, breaks=72, col="black", plot=F)
ggplot(data.table(Time=as_datetime(time_histogram$mids), Density=time_histogram$density), aes(Time, Density)) + geom_point() + geom_smooth(span=0.25) + scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M", minor_breaks = NULL)

```

The total spend per term is remarkably constant during my undergraduate years apart from summer of year 3 when my accommodation was heavily discounted. From year 5 onwards the terms are longer which explains the general increase and in the first term of year 6 I went on a trip to Vancouver which probably explains some of that peak.

```{r by-term, fig.width=10}
# Aggregate: Price Per Term
FinanceByTerm <- Finance[,.(Spend = sum(Price, na.rm = T)), by = c('Term','Year')]

# Histogram - Spend Per Term
ggplot(FinanceByTerm[Term!="Christmas"], aes(Term,Spend)) +
  geom_col() +
  theme(axis.text.x=element_text(angle=40,hjust=1,vjust=1,size=15)) +
  scale_y_continuous(labels = dollar_format(prefix = "£"))+
  labs(x="Term", y="Termly Spend") + facet_grid(~Year)
```

Breaking down my spending by category, Rent accounts for over 70% of my spending followed by Food at ~15%.

```{r by-category, fig.width=10}
# Aggregate: Spend Per Categrory
FinanceByCategory <- Finance[,.(Spend = sum(Percentage, na.rm = T)), by = Category]
FinanceByCategory[, Category := factor(Category, levels=FinanceByCategory[order(Spend)]$Category)]

# Histogram Spend Per Vendor
ggplot(FinanceByCategory, aes(Category, Spend)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent)+
	labs(x="Category", y="Total Spend Per Category")

```

Looking at total spend per vendor the top three vendors simply reflect my rental expenditure, followed by Tesco's and Sainsbury's where I do my grocery shopping.

```{r by-vendor, fig.width=10}
# Aggregate: Spend Per Vendor
FinanceByVendor <- Finance[,.(Spend = sum(Percentage, na.rm = TRUE)), by = Vendor]
FinanceByVendor[,Vendor := factor(Vendor, levels=FinanceByVendor[order(Spend)]$Vendor)]

# Histogram Spend Per Vendor
ggplot(FinanceByVendor[order(-Spend)][1:15], aes(Vendor,Spend)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
	labs(x="", y="Total Spend Per Vendor")

#scale_y_continuous(labels = dollar_format(prefix = "£"))+

```

My most commonly bought items are milk, bananas and bread. 

```{r by-item, fig.width=10}
# Aggregate: Number of items
FinanceByItem <- Finance[,.(Spend = sum(Price, na.rm=T),.N), by = Item][order(-N)]
FinanceByItem[,Item := factor(Item, levels=FinanceByItem[order(N)]$Item)]

# Histogram Number of items
ggplot(FinanceByItem[order(-N)][1:20], aes(Item,N)) +
  geom_col() +
  coord_flip() +
	labs(x="", y="Total Number of Purchases")

# to fix, banana(s), carrot(s), Potatoe(s), caps custard creams, Apple(s)
```